# Soft Processor Unit (SPU)
## Оглавление
- [Проект](#проект)
- [Особенности](#особенности)
- [Компоненты](#компоненты)
   - [Ассемблер](#ассемблер)
   - [Дизассемблер](#дизассемблер)
   - [Процессор](#процессор)
- [Система команд](#система-команд)
- [Формат байт-кода](#формат-байт-кода)
- [Пример использования](#пример-использования)
- [Todo](#todo)
- [Пояснения](#пояснения)

## Проект

Виртуальная машина с поддержкой ассемблирования, исполнения и дизассемблирования.
Проект включает в себя три программы: эмулятор процессора, ассемблер и дизассемблер.

## Особенности

- **Гарвардская архитектура** [1]
- **Упрощенный ассемблер**
- **Видеопамять** как часть оперативной памяти (размер n²) [2]

## Компоненты

### 1. Ассемблер
- Компилирует исходный псевдо-ассемблерный [3] код в бинарный формат
- Пример компиляции:
```bash
> make assembly
assembly COMPILED
To start an assembly write: ./build/assembly [--input / --output] [file PATH]
> ./build/assembly --input print_heart.asm
```
Процессор и дизассемблер используются аналогичным образом

### 2. Дизассемблер
- Преобразует инструкции процессора в ассемблер.
- **Ограничение:** не отображает названия меток, так как в проекте отсутсвует таблица имён.

### 3. Процессор
- Выполняет файлы формата .bin,

## Система команд
| Команда    | Аргументы               | Описание                                  |
|------------|-------------------------|-------------------------------------------|
| `PUSH`     | Число/регистр/память     | Помещает значение в стек                  |
| `POP`      | Регистр/память           | Извлекает значение из стека               |
| `ADD`      | —                       | Сложение двух верхних значений стека      |
| `SUB`      | —                       | Вычитание верхнего значения из второго    |
| `DIV`      | —                       | Деление второго значения на верхнее       |
| `OUT`      | —                       | Вывод значения из стека в stdout          |
| `IN`       | —                       | Чтение числа из stdin в стек              |
| `MUL`      | —                       | Умножение двух верхних значений стека     |
| `HLT`      | —                       | Остановка процессора                      |
| `JA`       | Метка                   | Переход если второе > первого (без знака) |
| `JAE`      | Метка                   | Переход если второе >= первого (без знака)|
| `JB`       | Метка                   | Переход если второе < первого (без знака) |
| `JBE`      | Метка                   | Переход если второе <= первого (без знака)|
| `JE`       | Метка                   | Переход если значения равны               |
| `JNE`      | Метка                   | Переход если значения не равны            |
| `JMP`      | Метка                   | Безусловный переход                       |
| `CALL`     | Метка                   | Вызов подпрограммы                        |
| `RETURN`   | —                       | Возврат из функции                   |
| `DRAW`     | —                       | Обновление видеопамяти/вывод на экран     |
| `SQRT`     | —                       | Вычисление квадратного корня из значения  |

### Регистры:
- `AX`, `BX`, `CX`, `DX` — 32-битные регистры общего назначения

Примечания:
1. Арифметические команды (`ADD`, `SUB` и др.) работают с верхними значениями стека
2. Адреса для переходов указываются в байт-коде процессора
3. `DRAW` использует видеопамять, отображая область RAM на экран

## Формат байт-кода
Каждая инструкция кодируется как:
```
PUSH 5 ----->   01           01          05
	         cmd code / arg type code / arg

Arg type code: 0 0 0 0 0 0 0 0
                         | | |
                         | | i (immediate const)
                         | |
                         | r (register)
                         |
                         m (memory)
```
### Примеры кодирования:
```
PUSH 5        ---> 01 01 05 (i)
PUSH CX       ---> 01 02 03 (R)
PUSH [5]      ---> 01 05 05 ([i]) - 00000101
PUSH [CX]     ---> 01 06 03 ([R]) - 00000110
PUSH [CX + 5] ---> 01 07 05 03 ([R + i]) - 00000111
                          | |
                          i R
```
Такой байт-код в проекте называется неравномерным, по причине того, что команды и аргументы имеют разную длину.

## Пример использования
![Make](img/Screenshot%202025-04-14%20at%2008.09.20.png)
![Run](img/Screenshot%202025-04-14%20at%2008.14.16.png)

## Todo
- Дизассемблер. После того как был сделан неравномерный код, данная функция не поддерживается.

## Пояснения
1. **Гарвардская архитектура** — архитектура ЭВМ, отличительными признаками которой являются: хранилище инструкций и хранилище данных представляют собой разные физические устройства

2. **Объем памяти n^2**. Почему квадрат? Из оперативной памяти также сделана видеопамять, для простоты в проекте подразумевается, что вся оперативная память отображается на экран, но в реальности это, конечно, не так.

3. **Псевдо-ассемблер** — упрощённый язык ассемблера в проекте, с ограниченным набором команд